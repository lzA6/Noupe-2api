# Noupe-local/nginx.conf

# å…¨å±€æ€§èƒ½è®¾ç½®
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # --- ä¸Šæ¸¸æœåŠ¡å™¨ç»„ (æˆ‘ä»¬çš„ FastAPI å·¥äºº) ---
    upstream noupe_backend {
        # å…³é”®ä¿®æ­£ ğŸš€: ä½¿ç”¨å®Œæ•´çš„ Cookie è¯·æ±‚å¤´è¿›è¡Œå“ˆå¸Œï¼Œå®ç°â€œç»ˆæç²˜æ€§ä¼šè¯â€
        # Noupe/Jotform çš„è®¤è¯å’Œä¼šè¯ä¾èµ–äºå¤šä¸ª Cookie (JOTFORM_SESSION, cf_clearance ç­‰)ã€‚
        # ç›´æ¥å¯¹æ•´ä¸ª $http_cookie å˜é‡è¿›è¡Œå“ˆå¸Œï¼Œå¯ä»¥ç¡®ä¿åªè¦å®¢æˆ·ç«¯çš„ Cookie é›†åˆä¸å˜ï¼Œ
        # è¯·æ±‚å°±ä¼š 100% å‘½ä¸­åŒä¸€ä¸ªåç«¯å®ä¾‹ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³äº†æµå¼å¯¹è¯çš„ä¸Šä¸‹æ–‡ä¸¢å¤±é—®é¢˜ã€‚
        hash $http_cookie consistent;

        # å®šä¹‰åç«¯ workerã€‚docker-compose ä¼šå°†æœåŠ¡å 'app' è§£æä¸ºå®¹å™¨ IPã€‚
        server app:8000;
    }

    # --- ä¸»æœåŠ¡å™¨é…ç½® (API ç½‘å…³) ---
    server {
        listen 80;
        server_name localhost;

        location / {
            proxy_pass http://noupe_backend;

            # --- æµå¼ä¼ è¾“ç»ˆæä¼˜åŒ– ---
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;

            # --- æ ‡å‡†å¤´ä¿¡æ¯è½¬å‘ ---
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
